#!/bin/bash

# 
# CREATE_VPN.SH
#  
# verify root
ID=`/usr/bin/id -u`
[ $ID -ne 0 ] && echo "You must be root to run $0." && exit 1

# check for running container
if [ -f ./.container ]; then
  CONTAINER="`cat .container`"
else
  echo "No Running Container!"
  exit 1
fi
[ ./.posip ] && POSIP="`cat ./.posip`"

# gather user input.
## example padss requirement info.
INPUTS="LOCATION_NAME STORE_PUBLIC STORE_NET PRESHAREDKEY"
POS_CLOUD_PUBLIC=`docker exec ${CONTAINER} wget -qO- http://ipv4.icanhazip.com`
SHOPCODE=`cat .shopcode`

echo "Gathering required information...."
for var in $INPUTS; do
  echo -n "Enter $var: "
  read REPLY
  export $var=$REPLY
done

# verify input
if [ "$INPUTS" != "" ]; then
echo "ipsec VPN Connection about to be created:"
echo "--------------------"
echo "Continue y/n?"
read -p ""
if [ $REPLY == "n" ]; then
  exit 1
else
# configure strongSwan
echo "Creating VPN Connection......"

echo "# ipsec.conf - strongSwan IPsec configuration file">ipsec.conf
echo "">>ipsec.conf
echo "# basic configuration">>ipsec.conf
echo "config setup">>ipsec.conf
echo "        charondebug="all"">>ipsec.conf
echo "        uniqueids=yes">>ipsec.conf
echo "        strictcrlpolicy=no">>ipsec.conf
echo "">>ipsec.conf
echo "# connection to $LOCATION_NAME">>ipsec.conf
echo "conn ${LOCATION_NAME}">>ipsec.conf
echo "  keyexchange=ikev1">>ipsec.conf
echo "  authby=secret">>ipsec.conf
echo "  left=%defaultroute">>ipsec.conf
echo "  leftid=${POS_CLOUD_PUBLIC}">>ipsec.conf
echo "  leftsubnet="192.168.222.0/24"">>ipsec.conf
echo "  rightid=${STORE_PUBLIC}">>ipsec.conf
echo "  rightsubnet="${STORE_NET}/24"">>ipsec.conf
echo "  ike=aes128-sha1-modp1024!">>ipsec.conf
echo "  esp=aes128-sha1-modp1024!">>ipsec.conf
echo "  keyingtries=0">>ipsec.conf
echo "  ikelifetime=1h">>ipsec.conf
echo "  lifetime=8h">>ipsec.conf
echo "  dpddelay=30">>ipsec.conf
echo "  dpdtimeout=120">>ipsec.conf
echo "  dpdaction=restart">>ipsec.conf
echo "  auto=start">>ipsec.conf

echo "# ipsec.secrets - strongSwan IPsec secrets file">ipsec.secrets
echo "# source destination secret">>ipsec.secrets
echo "${POS_CLOUD_PUBLIC} ${STORE_PUBLIC} : PSK "${PRESHAREDKEY}"">>ipsec.secrets

cat << xxxEOFxxx > xl2tpd.conf
[global]
listen-addr = 192.168.222.221
; force userspace = yes
; debug tunnel = yes

[lns default]
ip range = 192.168.222.1-192.168.222.254
local ip = 192.168.222.221
require chap = yes
refuse pap = yes
require authentication = yes
name = LinuxVPNserver
ppp debug = yes
pppoptfile = /etc/ppp/options.xl2tpd
length bit = yes 
xxxEOFxxx

cat << xxxEOFxxx > options.xl2tpd
ipcp-accept-local
ipcp-accept-remote
ms-dns  8.8.8.8
#ms-dns  1.1.1.1
noccp
auth
idle 1800
mtu 1410
mru 1410
nodefaultroute
debug
proxyarp
connect-delay 5000
xxxEOFxxx

cat << xxxEOFxxx > strongswan.conf
charon {
  	load = random nonce aes sha1 sha2 curve25519 hmac stroke kernel-netlink socket-default updown
        load_modular = yes
        plugins {
                include strongswan.d/charon/*.conf
        }
}
xxxEOFxxx

chmod 666 ipsec.*

# copy produced config files and vpn_client.sh to container.
docker cp ./ipsec.conf "${CONTAINER}:/etc/strongswan/ipsec.conf"
docker cp ./ipsec.secrets "${CONTAINER}:/etc/strongswan/ipsec.secrets"
docker exec ${CONTAINER} chmod 600 /etc/strongswan/ipsec.secrets
docker cp ./vpn_client.sh "${CONTAINER}:/etc/strongswan/vpn_client.sh"

# configure vpn connections.
docker exec ${CONTAINER} /etc/strongswan/vpn_client.sh init

# starting vpn connection in container.
docker exec ${CONTAINER} /usr/local/bin/vpn_client.sh start
echo "VPN Connection Started."
fi
else
echo "Nothing to do."
fi
exit 0
